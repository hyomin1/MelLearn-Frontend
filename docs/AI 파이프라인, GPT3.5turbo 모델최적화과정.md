# gpt3.5-turbo 모델 성능 최적화 과정

## 만들어야 하는 모델
노래의 가사를 주면 사용자의 학습능력에 맞는 10개의 문제를 제공하는 인공지능 모델

## Playground에서 사용해보며 알게된 것.

파인튜닝 전에 모델을 사용해보며 범위를 알아야 한다. 파인튜닝으로 얻고싶은 결과의 범위를 정해야한다.
Playground에서 System에 역할을 부여한 후 gpt-3.5turbo-0125 모델에 문제 생성을 요청해보았다.
System에 부여한 역할은 아래와 같다.

> 너는 외국어 단어 문제 출제 위원이야.
> 너는 유저가 준 인풋들을 토대로 문제집을 만들어야해.
> 너가 만든 문제의 선택지와 정답은 애매하지 않고 반드시 명확해야해.
> 아래는 유저 인풋 설명이야.
> 1. level : 1~3까지의 범위가 주어져. 3단계로 갈수록 전문가 수준의 문제를 출제해야해.
> 2. totalProblem : 너가 만들어야 하는 문제의 개수를 나타내.
> 3. text: 유저가 제공하는 문장들이야. 
> 아래는 assistence 아웃풋 설명이야.
> 1. question : 너는 문제 출제 방식으로 빈칸뚫기, 동의어 반의어를 물어보는 유형을 채택해야해. 한 문장에 두개 이상의 question을 물어볼 수 없어. 'text'에서 인용한 외국어를 제외하고는 한국어를 사용해서 질문해야해.
> 2. selection : 4가지 선택지를 제공해야해. 각 선택지에 있는 정답과 오답이 명확해야해. 선택지는 외국어로 제공되어야 해.
> 3. answer : 선택지중에 정답인 선택지를 정수로 알려줘야해.
> 4. comment : 문제가 정답인 이유를 자세하게 적어줘야해. 유저가 알아 들을 수 있도록 반드시 한국어로 설명해야해.

### 1. 필요없는 문장들 제거. 

2번째 줄. 너는 유저가 준 인풋들을 토대로 문제집을 만들어야해. -> 이 설명은 너무 당연하다. 따라서 필요없는 문장이다.

3번째 줄. 너가 만든 문제의 선택지와 정답은 애매하지 않고 반드시 명확해야해. -> 어떤 문제와 선택지가 애매한지 설명하지 않았다. 필요없는 문장인거 같다.

따라서 2,3번째 줄은 삭제하는게 맞다. 토큰만 잡아먹는다.

### 2. 명확한 명령을 하지 않았다.

level을 1부터3까지 나누었는데 3단계로 갈수록 전문가 수준이라고 모델에게 설명했다. 
하지만 1단계에 대한 설명을 하지 않고 최대 단계의 수준만 모델에게 설명했기 때문에 모델이 제공하는 단계의 문제 수준 차이가 모호하다고 느꼈다.
그래서 1단계에 대해서 해당 언어를 처음 배우는 초보자 라는 설명을 추가했다.

### 3. 응답 포맷을 system의 역할부여에 적을필요가 없다.

응답의 포맷은 파인튜닝과 Function Calling을 사용하여 해결할 수 있다.
따라서 System에 모델의 응답 포맷을 적지 않아도 된다.
특히 Function Calling을 사용해서 우리 모델의 포맷에 맞춰주는 작업을 수행할 수 있는 것 같다. 이건 더 알아보자.

## 4. 발생한 문제와 해결방법 생각.

### 1. 문제, 선택지, 해설의 사용 언어

문제와 해설은 사용자의 언어(한국어)로 제공되어야 한다. 이 때 본문에서 인용한 글은 그 언어 그대로 제공되어야 한다.
예를들어
> 문장에서 'We will be alright in the afterlife' 'alright'의 반의어는 무엇인가?
> 라는 문제를 기대하여 프롬프트를 작성했지만, 다음과 같은 문제가 발생했다.
>> 1. 인용한 영어본문을 한국어로 해석하여 문제를 출제
>> 2. 문제를 영어로 출제하여 영어에 익숙하지 않은 사용자가 문제의 난이도보다 문제 해석이 어려워지는 문제 발생
>> 3. 선택지, 해설의 언어가 매 요청마다 달라지는 문제

종합하자면 매 요청마다 문제의 형식이 달라지는 문제가 발생했다.
이 문제는 프롬프트 엔지니어링으로 해결될 수 있는 문제라고 보여진다. 하지만 계속 프롬프트를 변경해봤지만 획일화된 답변을 얻을 수 없었다.
다시 시도해보고 만약 안될경우 파인튜닝으로 해결할 생각을 해야겠다.
파인튜닝 데이터셋을 준비할 때 모든 문제, 선택지, 해설의 입력 형식을 일치시키면 해결될 것 같다.

### 2. 최대 토큰수와 과적합 문제

파인튜닝 시킬 수 있는 토큰 수가 16,385토큰으로 정해져 있다.

파인튜닝을 시킬 때 최소 10개의 데이터셋을 준비해야 한다.

노래의 가사를 받아 10개의 문제와 해설을 제공하는 예제를 10개 만들어야 된다는 얘기다.

노래의 가사도 길고, 문제와 해설 10개도 많아 최대 토큰 수를 넘어버리는 문제가 발생하였다.

따라서 totalProblem key를 유저 input으로 받아서 학습 데이터셋의 totalProblem을 1로 고정시켜 토큰 수를 줄이고, 나중에 호출할 때 10으로 호출시킬 생각으로 파인튜닝 모델을 만들었다.

하지만 학습 데이터에서 1개의 문제를 만들어주는 assistence의 아웃풋을 학습했기 때문에 10개를 만들어주라고 호출해도 1개의 문제만 만들어주는 오류가 발생했다.

학습 데이터의 토큰수는 줄이고, 과적합도 해결하는 데이터셋을 새로 짜야한다.

요청하는 문제 수를 한문제로 고정하지말고, 1~3문제를 번갈아가며 학습 데이터셋을 만들어야 한다. 다른 요인들도 마찬가지.

### 3. 문제 출제 분야에 대한 모호함

우리 서비스는 문제의 출제 분야를 Vocabulary, Grammar로 나누어 제공하려고 한다.
Vocabulary 문제를 만들어주는 파인튜닝 모델을 만들었지만 문제를 해결할 수 있는 능력이 Vocabulary에 해당되지 않는 오류가 발생하였다.

> e.g
>> question : 'I'm a ______ at the top of my class.' 빈칸에 들어갈 단어는 무엇일까요?
>> selectionList : A) winner B) champion C) loser D) leader
>> answer : A

이 문제 형식을 보면 vocabulary 영역의 문제가 아닌 reading 영역의 문제이다.
저 문장만 봤을 때 모든 선택지가 들어가도 문제가 없다. 그래서 다른 문장들을 보고 파악해야 한다.
그렇다면 사용자가 문제를 풀 때 정답이 적혀있는 가사 데이터를 제공해야한다는 단점이 생긴다.
또한 Vocabulary 영역을 나눠둔 우리 모델에서 Reading 영역의 문제를 제공하기 때문에 제공하는 문제 제공 서비스 오류가 생긴다.

### 4. 문제 레벨에 대한 모호함

gpt모델에 사용자의 학습 레벨에 따라서 난이도를 조절해주라고 했지만 레벨의 경계가 너무나도 모호했다.

사실 gpt에게 명령을 지시한 나 조차도 정확한 기준이 없는 상태였다.

그래서 레벨을 나눌 수 있는 기준을 gpt에게 물어보았다.

![image](https://github.com/lushlife99/MelLearn/assets/101994803/e0326f80-73a5-444d-a8fb-7a23f4a1d7a8)

그래서 이 기준에 따라서 system 역할부여 프롬프트를 수정하였다.


3, 4번 문제해결 : Vocabulary유형의 문제 출제 서비스의 파이프라인 변경

# 문제 생성 파이프라인

> 문제유형 Grammar 파이프라인
>> 1. 프론트엔드 -> 백엔드에 문제 요청 (Params : 노래 정보, 문제 유형(grammar, voca), 사용자 레벨)
>> 2. 백엔드 -> OpanAI api (fine-tuning model : 사용자 수준과 문제 유형에 맞는 문제를 출제해주는 모델)
>> 3. 백엔드 -> OpenAI의 파인튜닝 모델의 응답을 객체로 변환 -> 데이터 처리, 저장 -> 프론트엔드에 응답.

~~> 문제유형 Vocabulary 파이프라인~~
>> ~~1. 프론트엔드 -> 백엔드에 문제 요청 (Params : 노래 정보, 문제 유형(grammar, voca), 사용자 레벨)~~
>> ~~2. 백엔드 -> OpenAI api (gpt3.5 turbo-0125 모델 : 사용자 레벨에 따른 난이도 기준을 정확하게 주어서 문제, 해설을 제공)~~
>> ~~3. 백엔드 -> OpenAI api에서 제공받은 데이터를 객체로 변환, 데이터 처리, 저장~~
>> ~~4. 백엔드 -> 단어 네트워크 데이터베이스(e.g Wordnet)을 사용하여 선택지를 분명하게 만듦 (Reading 유형이 아닌 Vocabulary 유형이 되게)~~
>> ~~만약 정답이 apple 이라면, 다른 선택지에 melon, banana가 아닌 airplane, weapon이 채택될 수 있도록 만드는게 목표. 선택지 제공 파이프라인 참고.~~
>>            
>> ~~6. 백엔드 -> 프론트엔드 Response~~

~~Grammar 유형은 레벨을 나누기도 쉽고, 문제의 유형이 확실하여서 파인튜닝 모델만을 사용하는 문제 생성 파이프라인(첫번째)를 사용하면 될 것 같다.~~
4/1 수정 -> 순수 자바 환경에서 nlp를 사용하는 방법이 한정적이다. 패스.

## Vocabulary 문제 생성 파이프라인

모델이 알아들을 수 있도록 프롬프트를 계속 수정해가야 한다.
매 주 주기적으로 모델이 생성해주는 퀴즈를 풀고 종합한 오류를 바탕으로 프롬프트를 수정해나갈 것이다.
만약 여기서 멈춘다면 프롬프트 체이닝, 파인튜닝의 방법을 사용해야 한다.

> ### 현재 모델이 만들어준 문제의 오류 종류 (4/1 업데이트)
> 
> 문제를 푸는 사용자는 노래의 대략적인 분위기 정도만 파악했다고 전제한다. (사용자는 가사의 의미, 문맥 등의 세부 정보를 알지 못함)
>> #### 빈칸의 정답과 option 불일치


            question": "I've been reading books of old The legends and the myths The moon and its ___",

            "options": [
                "sun",
                "stars",
                "planets",
                "galaxy"
            ],
            "answer": "2",
            "comment": "이 문장에서 'The moon and its eclipse'는 '달과 그 음모들'을 의미합니다. 'moon'과 관련이 있는 'sun', 'stars', 'galaxy'는 여기에 적절하지 않습니다. 'sun'은 해와 관련이 있고, 'stars'는 별들과, 'galaxy'는 은하와 관련이 있습니다. 'moon'과 일치하지 않습니다."


>> #### 중복 정답
>> 사용자는 곡의 전체적인 분위기는 파악하고 있다고 가정한다. 따라서 ordinary를 제외한 모든 단어가 정답이 될 수 있다.


           "question": "I'm not lookin' for somebody With some ___ gifts",
            "options": [
                "ordinary",
                "superhuman",
                "mysterious",
                "magical"
            ],
            "answer": "2",
            "comment": "이 문장에서 'With some mysterious gifts'는 '어떤 수수께끼같은 선물을 가진 사람을 찾고 있지 않아'라는 뜻입니다. 'mysterious'가 가장 적합한 단어이며, 'ordinary', 'superhuman', 'magical'은 여기에 적합하지 않습니다. 'ordinary'는 평범한, 'superhuman'은 초능력을 갖춘, 'magical'은 마법 같은 단어이지만, 'mysterious'와는 맞지 않습니다."




>> #### 생성된 question의 빈칸이 모호함.
>> 빈칸이 한정적인 단어가 아닌 대부분의 단어로 대체될 수 있다.

            "question": "Superman unrolls A suit before he ___",
            "options": [
                "flies",
                "jumps",
                "dances",
                "paints"
            ],
            "answer": "3",
            "comment": "이 문장에서 'Superman unrolls A suit before he lifts'는 'Superman은 올리기 전에 의상을 펼칩니다.'라는 뜻입니다. 'lifts'와 관련이 있는 'flies', 'jumps', 'paints'는 여기에 어울리지 않습니다. 'flies'는 날다, 'jumps'는 뛰다, 'paints'는 그리는 행위를 의미하는데, 'lifts'와 의미가 맞지 않습니다."

>>> #### 해결방법 : 정확한 문제 생성 기준을 제공. (빈칸을 뚫는 구체적 지침을 제공)

>> #### 선택지의 모호함.
이 문제는 생성된 question의 빈칸이 모호한 경우에도 포함되지만, 선택지를 보면 기준이 모호한 것을 볼 수 있다. 선택지는 반의어 관계처럼 확실하게 뜻이 다르거나, 문맥 상 유추할 수 있는 단어여야 한다.

            "question": "Superman unrolls A suit before he ___",
            "options": [
                "flies",
                "jumps",
                "dances",
                "paints"
            ],
            "answer": "3",
            "comment": "이 문장에서 'Superman unrolls A suit before he lifts'는 'Superman은 올리기 전에 의상을 펼칩니다.'라는 뜻입니다. 'lifts'와 관련이 있는 'flies', 'jumps', 'paints'는 여기에 어울리지 않습니다. 'flies'는 날다, 'jumps'는 뛰다, 'paints'는 그리는 행위를 의미하는데, 'lifts'와 의미가 맞지 않습니다."



>> #### 의미 없는 멜로디, 전치사에 관한 문제를 출제


             "question": "I want something just like this Do ___-doo, doo-doo",
            "options": [
                "mi",
                "re",
                "sol",
                "la"
            ],
            "answer": "1",
            "comment": "이 문장에서 'Do re-doo, doo-doo'는 가사에서 나오는 멜로디 일부를 반복하는 부분입니다. 're'가 문맥적으로 가장 적합한 단어이며, 'mi', 'sol', 'la'는 여기에 맞지 않습니다. 'mi', 'sol', 'la'는 멜로디 중 다른 음향을 대표하는 단어이지만, 're'와는 관련이 없습니다."






### Grammar 문제 생성 파이프라인


